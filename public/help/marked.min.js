// Lightweight local shim providing `marked.parse()` for the help page.
// This is NOT the full marked library but provides adequate Markdown -> HTML
// parsing for headings, lists, images, links, code blocks and paragraphs.
(function(){
  function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function parse(md){
    if(typeof md !== 'string') return '';
    const lines = md.replace(/\r\n/g,'\n').split('\n');
    let out = '';
    let inList = false;
    let inCode = false;
    for(let i=0;i<lines.length;i++){
      let line = lines[i];
      if(line.startsWith('```')){ inCode = !inCode; out += inCode ? '<pre><code>' : '</code></pre>'; continue; }
      if(inCode){ out += escapeHtml(line)+'\n'; continue; }
      if(/^#{1,6}\s/.test(line)){
        const m = line.match(/^(#{1,6})\s+(.*)$/);
        out += `<h${m[1].length}>${m[2]}</h${m[1].length}>`;
        continue;
      }
      if(/^!\[.*\]\(.*\)/.test(line)){
        const m = line.match(/^!\[(.*)\]\((.*)\)/);
        out += `<p><img src="${m[2]}" alt="${m[1]}" style="max-width:100%"/></p>`; continue;
      }
      if(/^\[.*\]\(.*\)/.test(line)){
        const m = line.match(/^\[(.*)\]\((.*)\)/);
        out += `<p><a href="${m[2]}">${m[1]}</a></p>`; continue;
      }
      if(/^\s*[-*+]\s+/.test(line)){
        if(!inList){ inList = true; out += '<ul>'; }
        out += `<li>${line.replace(/^\s*[-*+]\s+/,'')}</li>`;
        const next = lines[i+1]||'';
        if(!/^\s*[-*+]\s+/.test(next)){ inList = false; out += '</ul>'; }
        continue;
      }
      if(line.trim()===''){ out += '<p></p>'; continue; }
      out += `<p>${line}</p>`;
    }
    return out;
  }
  window.marked = { parse };
})();
